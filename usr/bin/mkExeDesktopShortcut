#!/bin/bash

if [[ $# < 1 ]]; then
    echo -e "\e[1m\e[31mMissing input file.\e[0m
    \e[1mSyntax:\e[0m \e[3mmkExeDesktopShortcut <filename>\e[0m"
    exit
fi

input=$1

if ( file --mime-type "$input" | grep -o "application/x-dosexec" >/dev/null ); then
    echo -e "\e[1m\e[1;33mWorking on file:\e[0m \e[3m\e[96m\"$input\"\e[0m\e[1m\e[1;33m."
else
    echo -e "\e[1m\e[31mERROR: File is not a Windows executable:\e[0m \e[3m\e[96m\"$input\"\e[0m\e[1m\e[31m."
    exit
fi

input_folder=${input%/*}

if [ ! -w "$input_folder" ]; then
    echo -e "\e[1m\e[31mERROR: Folder is not writable:\e[0m \e[3m\e[96m\"$input_folder\"\e[0m\e[1m\e[31m."
    exit
fi

input_filename=${input##*/}
input_title=$(echo ${input_filename%.exe} | sed -s "s/_/ /g")

echo -e "\e[1m\e[95mCMD PARAMS
| FILENAME\e[0m \e[3m\e[96m$input_filename\e[0m \n\e[1m\e[95m| FOLDER\e[0m   \e[3m\e[96m$input_folder\e[0m \n\e[1m\e[95m| TITLE\e[0m    \e[3m\e[96m$input_title\e[0m"

echo -e "\e[1m\e[1;33mExtracting icon resources from executable.\e[0m"

wrestool --type=-14 --extract --output="$input_folder/$input_title.ico" "$input"
if [[ $? > 0 ]]; then
    echo -e "\e[1m\e[31mAn error has occurred while extracting resources.\e[0m ($?)"
else
    echo -e "\e[1m\e[32mFinished extracting resources.\e[0m"
fi

icon_path="$input_folder/$input_title.ico"

if ( file --mime-type "$icon_path" | grep -o "image/" >/dev/null ); then
    echo -e "\e[1m\e[32mSelected icon file:\e[0m \e[3m\e[96m\"$icon_path\"\e[0m\e[1m\e[32m.\e[0m"
else
    echo -e "\e[1m\e[1;33mWarning: File is not an image:\e[0m \e[3m\e[96m\"$icon_path\"\e[0m\e[1m\e[1;33m.\e[0m"
    echo -e "\e[1m\e[1;33mTrying to extract alternative icons.\e[0m"

    wrestool --type=-3 --extract --output="$input_folder/$input_title.ico" "$input"

    if ( file --mime-type "$icon_path" | grep -o "image/" >/dev/null ); then
        echo -e "\e[1m\e[32mSelected icon file:\e[0m \e[3m\e[96m\"$icon_path\"\e[0m\e[1m\e[32m.\e[0m"
    else
        echo -e "\e[1m\e[31mWarning: File is not an image:\e[0m \e[3m\e[96m\"$icon_path\"\e[0m\e[1m\e[31m.\e[0m"
    fi
fi


echo "[Desktop Entry]
Type=Application
MimeType=application/x-dosexec
Exec=\"$input\"
Name=$input_title
Path=$input_folder/
Icon=$icon_path
Comment=Launch $input_title
Comment[ar]=الإطلاق $input_title
Comment[cs]=Spustit $input_title
Comment[da]=Start $input_title
Comment[de]=$input_title starten
Comment[el]=Εκκίνηση $input_title
Comment[en]=Launch $input_title
Comment[es]=Iniciar $input_title
Comment[fi]=Käynnistä $input_title
Comment[fr]=Lancer $input_title
Comment[it]=Avviare $input_title
Comment[hi]=$input_title लॉन्च करें
Comment[hu]=Indítsa $input_title
Comment[hy]=Սկսել $input_title
Comment[id]=Luncurkan $input_title
Comment[is]=Ræstu $input_title
Comment[lt]=Palaist $input_title
Comment[pl]=$input_title starten
Comment[pt]=Iniciar $input_title
Comment[ru]=Запустить $input_title
Comment[sv]=Starta $input_title
Comment[th]=เปิด $input_title
Comment[uk]=Запустіть $input_title
Comment[vi]=Khởi chạy $input_title
Comment[zh]=启动$input_title
StartupNotify=true
Terminal=false" > "$HOME/Desktop/$input_title.desktop"

if [ ! -f "$HOME/Desktop/$input_title.desktop" ]; then echo -e "\e[1m\e[31mERROR: The file\e[0m \e[3m\e[96m\"$HOME/Desktop/$input_title.desktop\"\e[0m \e[1m\e[31mcould not be created.\e[0m"; exit; fi

echo -e "\e[1m\e[1;33mSetting shortcut execute permission.\e[0m"

chmod +x "$HOME/Desktop/$input_title.desktop"

if [[ $? > 0 ]]; then
    echo -e "\e[1m\e[31mERROR: couldn't set shortcut execute permission.\e[0m ($?)"
    exit
else
    echo -e "\e[1m\e[32mDesktop shortcut successfully generated on\e[0m \e[3m\e[96m\"$HOME/Desktop/$input_title.desktop\"\e[1m\e[32m.\e[0m"
fi
